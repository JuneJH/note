# 浏览器渲染原理

> 知晓浏览器渲染原理能够帮助我们更好完成性能优化、自信的设计架构工程。常见的面试题为：1. 请问从URL到浏览器展示出页面，浏览器做了哪些工作。

## 1. 工作单元

### 1. 浏览器主进程

### 2. 网络进程





### 2. 渲染进程

#### 1. 渲染主线程

##### 1. HTML解析

1. 解析HTML
   1. 获得一颗DOM树
   2. CSS解析
      1. 获得一颗CSSOM树
      2. 使用`document.styleSheets`操作用户样式表
      3. 启动预解析线程优先下载（网络线程）和解析css
      4. 不会阻塞HTML解析
   3. JS解析，渲染主线程遇到JS时必须暂停解析，等待下载执行完后才能继续，同理预解析线程可参与下载js任务
      1. 因为js 代码可能会改动HTML，因此需要暂停等待执行
2. 样式计算
   1. css属性的计算过程（补齐视觉格式化模型，盒模型和包含块流式布局）
      1. 层叠
      2. 集成
3. 布局

#### 2. 合成线程





## 2. 常见疑惑

### 1. Css加载会阻塞浏览器渲染吗

1. 不会，因为css加载会在预解析线程完成，预解析线程完成后会讲此过程包装为一个任务等待渲染主线程执行组装CSSOM树

### 2. Js加载会阻塞浏览器渲染吗，为什么要建议把script标签放在body标签后

	1. 会阻塞
 	2. 并不是说 script 标签必须放在底部，因为你可以给script 标签添加 defer 或者 async 属性。
     当 script 标签加上 defer 属性以后，表示该 JS ⽂件会并⾏下
     载，但是会放到 HTML 解析完成后顺序执⾏，所以对于这种情况你
     可以把 script 标签放在任意位置。
     对于没有任何依赖的 JS ⽂件可以加上 async 属性，表示 JS ⽂件下
     载和解析不会阻塞渲染。

### 3. transfer为什么性能高

#### 4. 为什么div、p标签是块盒

1. 因为在用户样式表中，手动设置了`display:block`；
2. 这也就解释了HTML是负责语义化，CSS负责样式





## 3. 参考

1. 当浏览器的网络线程收到HTML文档后，会产生一个渲染任务，并将其传递给渲染主线程的消息队列，在事件循环机制的作用下，渲染主线程取出消息队列中的渲染任务，开启渲染流程
2. 整个渲染流程分为多个阶段，分别是：HTML解析、样式计算、布局、分层、绘制、分块、光栅化、画。每个阶段都有明确的输入输出，上一个阶段的输出会成为下一阶段的输入。
3. 解析HTML
   1. 解析过程中遇到css解析css，遇到js执行js，为了提高解析效率，浏览器再开始解析前，会启动一个预解析的线程，率先下载HTML中的外部CSS文件和外部的JS文件
   2. 如果主线程解析到link位置，此时外部CSS文件还没有下载解析好，主线程不会等待，继续解析后续的HTML，这是因为下载和解析CSS的工作是在预解析线程中进行的，这就是CSS不会阻塞HTML解析的根本原因
   3. 如果主线程解析到script位置，会停止解析HTML，等待js文件下载好，并将全局代码解析执行完成后，才能继续解析HTML。这是因为JS代码执行过程中可能会修改当前的DOM树，所以DOM树的生成必须等待
   4. 此步骤会得到DOM树和CSSOM树，浏览器的默认样式、内部样式、外部样式、行内样式均会包含在CSSOM树中
4. 样式计算
   1. 主线程会遍历得到DOM树，依次为树中的每个节点计算出它最终的样式，称之为 `Computed Style`。
   2. 在这一过程中，很多预设值会变成绝对值，比如red会变成rgb(255,0,0);相对单位会变成绝对单位，比如em变成px
   3. 这一步之后，会得到一颗带有样式的DOM树
5. 布局，布局之后得到布局树
   1. 布局阶段会依次遍历DOM树的每一个节点，计算每一个节点的几何信息，比如节点的宽高、相对包含块的位置

